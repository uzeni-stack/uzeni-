<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Bilance Hmotnosti & Hled치n칤</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --primary: #1a237e; --bg: #f4f7f9; --klobasa: #2e7d32; --cabajka: #1565c0; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* Panel pro hled치n칤 a bilanci */
        .top-panel { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        
        .search-box { 
            padding: 12px; border: 2px solid #ddd; border-radius: 8px; 
            width: 100%; max-width: 300px; font-size: 1rem; outline: none;
        }
        .search-box:focus { border-color: var(--primary); }

        .bilance-box { 
            background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            display: flex; flex-wrap: wrap; gap: 10px; 
        }

        .bilance-item { 
            padding: 10px 18px; border-radius: 25px; font-weight: bold; 
            display: flex; align-items: center; gap: 10px; border: 2px solid #ddd;
            font-size: 1.1rem;
        }
        .barva-klobasa { background: #e8f5e9; color: var(--klobasa); border-color: var(--klobasa); }
        .barva-cabajka { background: #e3f2fd; color: var(--cabajka); border-color: var(--cabajka); }
        .barva-ostatni { background: #f5f5f5; color: #616161; border-color: #9e9e9e; }
        
        .vaha-cislo { font-size: 1.3rem; margin-left: 5px; }

        .zakaznik-karta { background: white; border-radius: 12px; padding: 20px; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .historie-tabulka { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .historie-tabulka td { padding: 8px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0">丘뒲잺 BILANCE & HISTORIE</h2>
    <a href="admin.html" style="text-decoration:none; font-weight:bold; color:var(--primary);">游 ADMIN</a>
</div>

<div class="top-panel">
    <input type="text" id="hledat" class="search-box" placeholder="Hledat z치kazn칤ka..." onkeyup="filtruj()">
    
    <div id="bilance-zbozi" class="bilance-box">Po캜칤t치m kila...</div>
</div>

<div id="seznam-historie"></div>

<script>
    const firebaseConfig = { databaseURL: "https://eshop-fh-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    db.ref("finance").on("value", snap => {
        const data = snap.val() || {};
        const zakaznici = {};
        const vahaSolo = {}; 

        for (let mesic in data) {
            if (data[mesic].trzby) {
                for (let id in data[mesic].trzby) {
                    const t = data[mesic].trzby[id];
                    
                    if (t.zbozi) {
                        const polo쬶y = t.zbozi.split(","); 
                        polo쬶y.forEach(p => {
                            const text = p.trim();
                            if (text === "") return;
                            let nazev = text.split("(")[0].trim();
                            const match = text.match(/\(([^)]+)\)/);
                            let vaha = 0;
                            if (match) {
                                vaha = parseFloat(match[1].replace(/[^\d.]/g, '')) || 0;
                            }
                            vahaSolo[nazev] = (vahaSolo[nazev] || 0) + vaha;
                        });
                    }

                    if (!zakaznici[t.zakaznik]) zakaznici[t.zakaznik] = [];
                    zakaznici[t.zakaznik].push({...t, id, mesic});
                }
            }
        }
        vykresliBilanci(vahaSolo);
        vykresliHistorii(zakaznici);
    });

    function vykresliBilanci(bilance) {
        const box = document.getElementById("bilance-zbozi");
        box.innerHTML = "";
        Object.keys(bilance).sort().forEach(nazev => {
            let trida = "barva-ostatni";
            const hledej = nazev.toLowerCase();
            if (hledej.includes("klobasa") || hledej.includes("klob치sa")) trida = "barva-klobasa";
            if (hledej.includes("캜abajka") || hledej.includes("cabajka")) trida = "barva-cabajka";
            const soucet = bilance[nazev].toFixed(2);
            box.innerHTML += `<div class="bilance-item ${trida}">${nazev}: <span class="vaha-cislo">${soucet} kg</span></div>`;
        });
    }

    function vykresliHistorii(zakaznici) {
        const kontejner = document.getElementById("seznam-historie");
        kontejner.innerHTML = "";
        Object.keys(zakaznici).sort().forEach(jmeno => {
            let radky = zakaznici[jmeno].reverse().map(n => 
                `<tr><td>${n.datum}</td><td>${n.zbozi}</td><td><b>${n.castka} K캜</b></td></tr>`
            ).join("");

            kontejner.innerHTML += `
                <div class="zakaznik-karta" data-jmeno="${jmeno.toLowerCase()}">
                    <div style="font-weight:bold; color:var(--primary); font-size: 1.2rem;">${jmeno}</div>
                    <table class="historie-tabulka"><tbody>${radky}</tbody></table>
                </div>`;
        });
    }

    // FUNKCE PRO FILTROV츼N칈
    function filtruj() {
        const text = document.getElementById("hledat").value.toLowerCase();
        const karty = document.querySelectorAll(".zakaznik-karta");
        karty.forEach(k => {
            const jmeno = k.getAttribute("data-jmeno");
            k.style.display = jmeno.includes(text) ? "block" : "none";
        });
    }
</script>
</body>
</html>
