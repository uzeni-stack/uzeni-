<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Historie z√°kazn√≠k≈Ø & Bilance</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --primary: #1a237e; --bg: #f4f7f9; --danger: #d32f2f; --success: #2e7d32; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* Nov√Ω styl pro horn√≠ ovl√°dac√≠ panel */
        .top-panel { display: flex; gap: 20px; align-items: flex-start; margin-bottom: 20px; flex-wrap: wrap; }
        
        .search-box { padding: 12px; border: 2px solid #ddd; border-radius: 8px; width: 250px; font-size: 1rem; }

        /* Styl pro bilanci zbo≈æ√≠ */
        .bilance-box { 
            background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; gap: 15px; flex-wrap: wrap; flex-grow: 1; border-left: 5px solid var(--success);
        }
        .bilance-item { background: #e8f5e9; padding: 5px 12px; border-radius: 20px; font-size: 0.9rem; color: var(--success); font-weight: bold; border: 1px solid #c8e6c9; }

        .zakaznik-karta { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .zakaznik-hlavicka { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .jmeno { font-size: 1.4rem; font-weight: bold; color: var(--primary); }
        
        .historie-tabulka { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .historie-tabulka th { text-align: left; color: #666; padding: 8px; border-bottom: 1px solid #ddd; }
        .historie-tabulka td { padding: 10px 8px; border-bottom: 1px solid #f9f9f9; }
        
        .btn-smazat-vse { background: #ffebee; color: var(--danger); border: 1px solid #ffcdd2; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-smazat-vse:hover { background: var(--danger); color: white; }
        .btn-smazat-radek { background: none; border: none; color: #ccc; cursor: pointer; font-size: 1rem; }
        .btn-smazat-radek:hover { color: var(--danger); }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0">üìú HISTORIE & CELKOV√Å BILANCE</h2>
    <a href="admin.html" style="text-decoration:none; font-weight:bold; color:var(--primary);">üè† ADMIN</a>
</div>

<div class="top-panel">
    <input type="text" id="hledat" class="search-box" placeholder="Hledat z√°kazn√≠ka..." onkeyup="filtruj()">
    
    <div id="bilance-zbozi" class="bilance-box">
        <span style="color:#666">Poƒç√≠t√°m celkovou bilanci zbo≈æ√≠...</span>
    </div>
</div>

<div id="seznam-historie">Naƒç√≠t√°m historii...</div>

<script>
    const firebaseConfig = { databaseURL: "https://eshop-fh-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    db.ref("finance").on("value", snap => {
        const data = snap.val() || {};
        const zakaznici = {};
        const bilanceZbozi = {}; // Zde budeme sƒç√≠tat v≈°echno zbo≈æ√≠

        for (let klicMesic in data) {
            if (data[klicMesic].trzby) {
                const trzbyMesice = data[klicMesic].trzby;
                for (let idTrzby in trzbyMesice) {
                    const t = trzbyMesice[idTrzby];
                    
                    // 1. Logika pro z√°kazn√≠ky
                    if (!zakaznici[t.zakaznik]) { zakaznici[t.zakaznik] = []; }
                    zakaznici[t.zakaznik].push({ ...t, id: idTrzby, klicMesic: klicMesic });

                    // 2. Logika pro bilanci zbo≈æ√≠ (sƒç√≠t√°n√≠ podle n√°zvu)
                    // P≈ôedpokl√°d√°me, ≈æe n.zbozi obsahuje n√°zev (nap≈ô. "Brambory 5kg")
                    const nazevZbozi = t.zbozi || "Nezn√°m√© zbo≈æ√≠";
                    if (!bilanceZbozi[nazevZbozi]) {
                        bilanceZbozi[nazevZbozi] = 0;
                    }
                    // Pokud m√°≈° v historii i mno≈æstv√≠ jako ƒç√≠slo, mohl bys sƒç√≠tat to, 
                    // ale teƒè sƒç√≠t√°me poƒçet v√Ωskyt≈Ø (prodej≈Ø) dan√©ho druhu.
                    bilanceZbozi[nazevZbozi] += 1; 
                }
            }
        }
        vykresliBilanci(bilanceZbozi);
        vykresli(zakaznici);
    });

    // Funkce, kter√° vykresl√≠ bubliny s celkov√Ωm poƒçtem prodan√Ωch vƒõc√≠
    function vykresliBilanci(bilance) {
        const box = document.getElementById("bilance-zbozi");
        box.innerHTML = '<strong style="width:100%; margin-bottom:5px; font-size:0.8rem; color:#666">CELKEM PROD√ÅNO (poƒçet polo≈æek):</strong>';
        
        const druhy = Object.keys(bilance).sort();
        if (druhy.length === 0) { box.innerHTML = "Zat√≠m ≈æ√°dn√° data."; return; }

        druhy.forEach(druh => {
            box.innerHTML += `<div class="bilance-item">${druh}: ${bilance[druh]}x</div>`;
        });
    }

    function vykresli(zakaznici) {
        const kontejner = document.getElementById("seznam-historie");
        kontejner.innerHTML = "";
        const jmena = Object.keys(zakaznici).sort();

        if (jmena.length === 0) {
            kontejner.innerHTML = "<h3>≈Ω√°dn√° historie zat√≠m neexistuje.</h3>";
            return;
        }

        jmena.forEach(jmeno => {
            let radkyHtml = "";
            let celkemUtraceno = 0;

            // Kopie pole pro se≈ôazen√≠ od nejnovƒõj≈°√≠ho
            const nakupy = [...zakaznici[jmeno]].reverse();

            nakupy.forEach(n => {
                celkemUtraceno += parseInt(n.castka);
                radkyHtml += `
                    <tr>
                        <td>${n.datum}</td>
                        <td>${n.zbozi}</td>
                        <td style="font-weight:bold">${n.castka} Kƒç</td>
                        <td style="text-align:right">
                            <button class="btn-smazat-radek" onclick="smazatJeden('${n.klicMesic}', '${n.id}')">‚úï</button>
                        </td>
                    </tr>`;
            });

            kontejner.innerHTML += `
                <div class="zakaznik-karta" data-jmeno="${jmeno.toLowerCase()}">
                    <div class="zakaznik-hlavicka">
                        <div>
                            <span class="jmeno">${jmeno}</span>
                            <div style="font-size:0.8rem; color:#666">Celkem u n√°s nechal: <b>${celkemUtraceno} Kƒç</b></div>
                        </div>
                        <button class="btn-smazat-vse" onclick="smazatVsechnuHistorii('${jmeno}')">Smazat celou kartu</button>
                    </div>
                    <table class="historie-tabulka">
                        <thead>
                            <tr><th>Datum</th><th>Zbo≈æ√≠</th><th>ƒå√°stka</th><th></th></tr>
                        </thead>
                        <tbody>${radkyHtml}</tbody>
                    </table>
                </div>`;
        });
    }

    function smazatJeden(klicMesic, id) {
        if (confirm("Opravdu smazat tento n√°kup?")) {
            db.ref(`finance/${klicMesic}/trzby/${id}`).remove();
        }
    }

    function smazatVsechnuHistorii(jmeno) {
        if (confirm(`Smazat komplet historii pro: ${jmeno}?`)) {
            db.ref("finance").once("value", snap => {
                const data = snap.val() || {};
                for (let klicMesic in data) {
                    if (data[klicMesic].trzby) {
                        const trzby = data[klicMesic].trzby;
                        for (let id in trzby) {
                            if (trzby[id].zakaznik === jmeno) {
                                db.ref(`finance/${klicMesic}/trzby/${id}`).remove();
                            }
                        }
                    }
                }
            });
        }
    }

    function filtruj() {
        const text = document.getElementById("hledat").value.toLowerCase();
        const karty = document.querySelectorAll(".zakaznik-karta");
        karty.forEach(k => {
            const jmeno = k.getAttribute("data-jmeno");
            k.style.display = jmeno.includes(text) ? "block" : "none";
        });
    }
</script>

</body>
</html>
