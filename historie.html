<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Bilance kg & √ösporn√Ω vzhled</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --primary: #1a237e; --bg: #f4f7f9; --klobasa: #2e7d32; --cabajka: #1565c0; --danger: #d32f2f; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 15px; margin: 0; }
        
        .header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
        
        .top-panel { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        
        .search-box { padding: 10px; border: 2px solid #ddd; border-radius: 8px; width: 100%; max-width: 250px; outline: none; }

        /* MO≈ΩNOST ƒå. 2: √ösporn√° bilance */
        .bilance-box { 
            background: white; padding: 12px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            display: flex; flex-wrap: wrap; gap: 8px; 
        }

        .bilance-item { 
            padding: 5px 12px; border-radius: 15px; font-weight: bold; 
            display: flex; align-items: center; gap: 6px; border: 2px solid #ddd;
            font-size: 0.9rem; /* Men≈°√≠ p√≠smo pro √∫sporu m√≠sta */
        }
        .barva-klobasa { background: #e8f5e9; color: var(--klobasa); border-color: var(--klobasa); }
        .barva-cabajka { background: #e3f2fd; color: var(--cabajka); border-color: var(--cabajka); }
        .barva-ostatni { background: #f5f5f5; color: #616161; border-color: #9e9e9e; }
        
        .vaha-cislo { font-size: 1rem; color: #000; }

        .zakaznik-karta { background: white; border-radius: 12px; padding: 15px; margin-top: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .zakaznik-hlavicka { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 8px; }
        
        .historie-tabulka { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .historie-tabulka td { padding: 6px; border-bottom: 1px solid #eee; }
        
        .btn-smazat-radek { background: none; border: none; color: #ccc; cursor: pointer; font-size: 1.1rem; }
        .btn-smazat-vse { background: #ffebee; color: var(--danger); border: 1px solid #ffcdd2; padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: bold; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0; font-size: 1.2rem;">‚öñÔ∏è CELKOV√Å BILANCE (kg)</h2>
    <a href="admin.html" style="text-decoration:none; font-weight:bold; color:var(--primary); font-size: 0.9rem;">üè† ADMIN</a>
</div>

<div class="top-panel">
    <input type="text" id="hledat" class="search-box" placeholder="Hledat z√°kazn√≠ka..." onkeyup="filtruj()">
    <div id="bilance-zbozi" class="bilance-box">Poƒç√≠t√°m v√°hu...</div>
</div>

<div id="seznam-historie"></div>

<script>
    const firebaseConfig = { databaseURL: "https://eshop-fh-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    db.ref("finance").on("value", snap => {
        const data = snap.val() || {};
        const zakaznici = {};
        const vahaSolo = {}; 

        for (let mesic in data) {
            if (data[mesic].trzby) {
                for (let id in data[mesic].trzby) {
                    const t = data[mesic].trzby[id];
                    if (t.zbozi) {
                        const polozky = t.zbozi.split(","); 
                        polozky.forEach(p => {
                            const text = p.trim();
                            if (text === "") return;
                            let nazev = text.split("(")[0].trim();
                            const match = text.match(/\(([^)]+)\)/);
                            if (match) {
                                // Vyt√°hne ƒç√≠slo a vydƒõl√≠ 1000 (p≈ôevod g na kg)
                                let gramy = parseFloat(match[1].replace(/[^\d.]/g, '')) || 0;
                                vahaSolo[nazev] = (vahaSolo[nazev] || 0) + (gramy / 1000);
                            }
                        });
                    }
                    if (!zakaznici[t.zakaznik]) zakaznici[t.zakaznik] = [];
                    zakaznici[t.zakaznik].push({...t, id, klicMesic: mesic});
                }
            }
        }
        vykresliBilanci(vahaSolo);
        vykresliHistorii(zakaznici);
    });

    function vykresliBilanci(bilance) {
        const box = document.getElementById("bilance-zbozi");
        box.innerHTML = "";
        Object.keys(bilance).sort().forEach(nazev => {
            let trida = "barva-ostatni";
            const hledej = nazev.toLowerCase();
            if (hledej.includes("klobasa") || hledej.includes("klob√°sa")) trida = "barva-klobasa";
            if (hledej.includes("ƒçabajka") || hledej.includes("cabajka")) trida = "barva-cabajka";
            
            // Zobrazen√≠ s p≈ôesnost√≠ na 2 desetinn√° m√≠sta
            box.innerHTML += `<div class="bilance-item ${trida}">${nazev}: <span class="vaha-cislo">${bilance[nazev].toFixed(2)} kg</span></div>`;
        });
    }

    function vykresliHistorii(zakaznici) {
        const kontejner = document.getElementById("seznam-historie");
        kontejner.innerHTML = "";
        Object.keys(zakaznici).sort().forEach(jmeno => {
            let radkyHtml = zakaznici[jmeno].reverse().map(n => `
                <tr>
                    <td>${n.datum}</td>
                    <td>${n.zbozi}</td>
                    <td style="font-weight:bold">${n.castka} Kƒç</td>
                    <td style="text-align:right">
                        <button class="btn-smazat-radek" onclick="smazatJeden('${n.klicMesic}', '${n.id}')">‚úï</button>
                    </td>
                </tr>`).join("");

            kontejner.innerHTML += `
                <div class="zakaznik-karta" data-jmeno="${jmeno.toLowerCase()}">
                    <div class="zakaznik-hlavicka">
                        <span style="font-weight:bold; color:var(--primary);">${jmeno}</span>
                        <button class="btn-smazat-vse" onclick="smazatVsechnuHistorii('${jmeno}')">Smazat v≈°e</button>
                    </div>
                    <table class="historie-tabulka"><tbody>${radkyHtml}</tbody></table>
                </div>`;
        });
    }

    function smazatJeden(klicMesic, id) {
        if (confirm("Smazat?")) { db.ref(`finance/${klicMesic}/trzby/${id}`).remove(); }
    }

    function smazatVsechnuHistorii(jmeno) {
        if (confirm(`Smazat v≈°e pro: ${jmeno}?`)) {
            db.ref("finance").once("value", snap => {
                const data = snap.val() || {};
                for (let mesic in data) {
                    if (data[mesic].trzby) {
                        for (let id in data[mesic].trzby) {
                            if (data[mesic].trzby[id].zakaznik === jmeno) {
                                db.ref(`finance/${mesic}/trzby/${id}`).remove();
                            }
                        }
                    }
                }
            });
        }
    }

    function filtruj() {
        const text = document.getElementById("hledat").value.toLowerCase();
        document.querySelectorAll(".zakaznik-karta").forEach(k => {
            k.style.display = k.getAttribute("data-jmeno").includes(text) ? "block" : "none";
        });
    }
</script>
</body>
</html>
