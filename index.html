<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Objednávka - Nová Verze</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --primary: #1a237e; --bg: #f4f7f9; --accent: #2e7d32; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .container { max-width: 500px; margin: 0 auto; }
        
        .section { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        
        .produkt-radek { border-bottom: 1px solid #eee; padding: 15px 0; }
        .flex-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; gap: 10px; }
        
        .stepper { display: flex; align-items: center; background: #f0f0f0; border-radius: 12px; padding: 4px; border: 1px solid #ddd; }
        .btn-krok { 
            background: white; border: 1px solid #ccc; width: 45px; height: 45px; 
            border-radius: 10px; font-size: 1.8rem; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center; color: var(--primary);
        }
        .vaha-displej { width: 65px; border: none; background: transparent; text-align: center; font-size: 1.3rem; font-weight: bold; }

        .btn-pridat { 
            background: var(--primary); color: white; border: none; padding: 12px; 
            border-radius: 10px; font-weight: bold; cursor: pointer; flex-grow: 1; font-size: 1rem;
            transition: background 0.3s;
        }
        .btn-success { background: var(--accent) !important; }

        .kosik-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #ccc; }
        .btn-odeslat { width: 100%; background: var(--accent); color: white; border: none; padding: 18px; border-radius: 15px; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .btn-odeslat:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="container">
    <div class="section">
        <label style="font-weight:bold;">Vaše jméno:</label>
        <input type="text" id="zakaznik-jmeno" style="width:100%; padding:12px; margin-top:8px; border-radius:10px; border:2px solid #ddd;" placeholder="Jméno a příjmení">
    </div>

    <div class="section">
        <h3 style="margin-top:0;">Dnešní nabídka:</h3>
        <div id="seznam-zbozi">Načítám...</div>
    </div>

    <div id="sekce-kosik" class="section" style="display:none;">
        <h3 style="margin-top:0;">Váš nákup:</h3>
        <div id="kosik-seznam"></div>
        <div style="text-align:right; margin-top:15px; font-size:1.4rem; font-weight:bold; color:#d32f2f;">
            Odhad: <span id="suma-cena">0</span> Kč
        </div>
        <button id="btn-odeslat" class="btn-odeslat" onclick="odeslatObjednavku()">ODESLAT OBJEDNÁVKU</button>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://eshop-fh-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let nabidka = {};
    let kosik = [];

    // Načtení zboží
    db.ref("produkty").on("value", snap => {
        nabidka = snap.val() || {};
        const div = document.getElementById("seznam-zbozi");
        div.innerHTML = "";

        Object.keys(nabidka).sort().forEach(zbozi => {
            const btnId = "btn-add-" + zbozi.replace(/\s+/g, '');
            div.innerHTML += `
                <div class="produkt-radek">
                    <div style="font-weight:bold; font-size:1.1rem;">${zbozi}</div>
                    <div style="color:#666;">${nabidka[zbozi]} Kč/kg</div>
                    <div class="flex-row">
                        <div class="stepper">
                            <button class="btn-krok" onclick="upravitVahu('${zbozi}', -0.5)">−</button>
                            <input type="text" id="vaha-${zbozi}" class="vaha-displej" value="1.0" readonly>
                            <button class="btn-krok" onclick="upravitVahu('${zbozi}', 0.5)">+</button>
                        </div>
                        <button class="btn-pridat" id="${btnId}" onclick="vlozitDoKosiku('${zbozi}', this)">PŘIDAT</button>
                    </div>
                </div>`;
        });
    });

    function upravitVahu(id, oKolik) {
        const pole = document.getElementById("vaha-" + id);
        let hodnota = parseFloat(pole.value);
        hodnota = Math.max(0.5, hodnota + oKolik);
        pole.value = hodnota.toFixed(1);
    }

    function vlozitDoKosiku(nazev, tlacitko) {
        const pole = document.getElementById("vaha-" + nazev);
        const vaha = parseFloat(pole.value);
        const index = kosik.findIndex(i => i.nazev === nazev);
        
        if (index > -1) { 
            kosik[index].vaha += vaha; 
        } else { 
            kosik.push({ nazev: nazev, vaha: vaha, cenaKg: nabidka[nazev] }); 
        }
        
        // TRVALÝ EFEKT TLAČÍTKA
        tlacitko.innerText = "PŘIDÁNO ✅";
        tlacitko.classList.add("btn-success");

        pole.value = "1.0"; 
        prekresliKosik();
    }

    function prekresliKosik() {
        const div = document.getElementById("kosik-seznam");
        const sekce = document.getElementById("sekce-kosik");
        if (kosik.length === 0) { sekce.style.display = "none"; return; }
        
        sekce.style.display = "block";
        div.innerHTML = "";
        let celkem = 0;
        
        kosik.forEach((p, idx) => {
            const cena = Math.round(p.vaha * p.cenaKg);
            celkem += cena;
            div.innerHTML += `
                <div class="kosik-item">
                    <span><b>${p.nazev}</b> (${p.vaha.toFixed(1)} kg)</span>
                    <span>${cena} Kč <button onclick="odstranit(${idx})" style="color:red; border:none; background:none; font-weight:bold; cursor:pointer;">✕</button></span>
                </div>`;
        });
        document.getElementById("suma-cena").innerText = celkem;
    }

    function odstranit(idx) { 
        const smazanaPolozka = kosik[idx].nazev;
        kosik.splice(idx, 1); 
        prekresliKosik(); 

        // Vrácení tlačítka do původního stavu
        const staleVKosiku = kosik.some(i => i.nazev === smazanaPolozka);
        if (!staleVKosiku) {
            const btnId = "btn-add-" + smazanaPolozka.replace(/\s+/g, '');
            const btn = document.getElementById(btnId);
            if (btn) {
                btn.innerText = "PŘIDAT";
                btn.classList.remove("btn-success");
            }
        }
    }

    function odeslatObjednavku() {
        const jmeno = document.getElementById("zakaznik-jmeno").value.trim();
        const tlacitko = document.getElementById("btn-odeslat");
        
        if (!jmeno) { 
            alert("Prosím, vyplňte své jméno!"); 
            return; 
        }
        
        tlacitko.disabled = true;
        tlacitko.innerText = "Posílám...";
        
        const idSkupiny = "obj_" + Date.now();
        const zapisy = kosik.map(p => {
            return db.ref("objednavky/" + p.nazev).push({
                zakaznik: jmeno, 
                vaha_objednano: p.vaha, 
                skutecna_vaha_gr: 0, 
                vydano: false, 
                datum: new Date().toLocaleDateString('cs-CZ'), 
                id_skupiny: idSkupiny
            });
        });

        Promise.all(zapisy).then(() => {
            alert("Objednávka odeslána!");
            location.reload(); // Pro úplný reset po úspěchu
        });
    }
</script>
</body>
</html>
