<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>V√Ωdej - Inteligentn√≠ karty</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --primary: #1a237e; --accent: #ff9800; --bg: #f4f7f9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .karta { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border-top: 8px solid var(--accent); }
        .karta-hlavicka { display: flex; justify-content: space-between; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .jmeno { font-size: 1.4rem; font-weight: bold; color: var(--primary); }
        
        .radek { display: grid; grid-template-columns: 2fr 1fr 1.5fr 1fr; gap: 15px; padding: 10px 0; border-bottom: 1px solid #fafafa; align-items: center; }
        .produkt-nazev { font-weight: 600; }
        
        input[type="number"] { width: 80px; padding: 8px; border: 2px solid #ddd; border-radius: 6px; text-align: center; font-weight: bold; font-size: 1.1rem; }
        input:focus { border-color: var(--accent); outline: none; }
        input[value="0"], input:placeholder-shown { border-color: #eee; color: #ccc; }

        .cena-polozka { text-align: right; font-weight: bold; color: #444; }
        .paticka { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 15px; border-top: 2px solid #eee; }
        .celkem { font-size: 1.8rem; font-weight: 900; color: #d32f2f; }
        
        .btn-vydat { background: var(--accent); color: white; border: none; padding: 12px 30px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        .btn-zpet { text-decoration: none; color: var(--primary); font-weight: bold; padding: 10px; border: 1px solid var(--primary); border-radius: 6px; }
        
        .status-badge { font-size: 0.7rem; background: #eee; padding: 3px 8px; border-radius: 10px; color: #777; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0">üöö V√ùDEJ ZBO≈Ω√ç</h2>
    <a href="admin.html" class="btn-zpet">üè† ADMIN</a>
</div>

<div id="seznam-karet">Naƒç√≠t√°m objedn√°vky...</div>

<script>
    const firebaseConfig = { databaseURL: "https://eshop-fh-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let cenyZbozi = {};

    // 1. Naƒçten√≠ cen
    db.ref("produkty").on("value", s => { cenyZbozi = s.val() || {}; });

    // 2. Naƒçten√≠ objedn√°vek a seskupen√≠
    db.ref("objednavky").on("value", snapshot => {
        if (document.activeElement.tagName === "INPUT") return;

        const data = snapshot.val() || {};
        const skupiny = {};
        let maNeco = false;

        for (let produkt in data) {
            for (let id in data[produkt]) {
                const obj = data[produkt][id];
                if (!obj.vydano) {
                    const klic = obj.id_skupiny || obj.zakaznik; 
                    if (!skupiny[klic]) {
                        skupiny[klic] = { jmeno: obj.zakaznik, datum: obj.datum, polozky: [] };
                    }
                    skupiny[klic].polozky.push({ ...obj, produkt: produkt, id: id });
                    maNeco = true;
                }
            }
        }
        vykresli(skupiny, maNeco);
    });

    function vykresli(skupiny, maNeco) {
        const kontejner = document.getElementById("seznam-karet");
        kontejner.innerHTML = "";

        if (!maNeco) {
            kontejner.innerHTML = "<h3>V≈°e je vyd√°no. ‚úÖ</h3>";
            return;
        }

        for (let idSkupiny in skupiny) {
            const s = skupiny[idSkupiny];
            let radkyHtml = "";
            let sumaKarty = 0;

            s.polozky.forEach(p => {
                const cenaKg = cenyZbozi[p.produkt] || 0;
                const vahaGr = p.skutecna_vaha_gr || 0;
                const cenaRadek = Math.round((vahaGr / 1000) * cenaKg);
                sumaKarty += cenaRadek;

                radkyHtml += `
                    <div class="radek">
                        <div class="produkt-nazev">${p.produkt}</div>
                        <div style="color:#777">Obj: ${p.vaha_objednano}kg</div>
                        <div>
                            <input type="number" value="${vahaGr || ''}" placeholder="0" 
                                onchange="ulozVahu('${p.produkt}','${p.id}', this.value)"> <small>gr</small>
                        </div>
                        <div class="cena-polozka">${cenaRadek} Kƒç</div>
                    </div>`;
            });

            kontejner.innerHTML += `
                <div class="karta">
                    <div class="karta-hlavicka">
                        <div class="jmeno">${s.jmeno} <span class="status-badge">ID: ${idSkupiny.slice(-5)}</span></div>
                        <div style="color:#888">${s.datum || ''}</div>
                    </div>
                    ${radkyHtml}
                    <div class="paticka">
                        <div class="celkem">${sumaKarty} Kƒç</div>
                        <button class="btn-vydat" onclick="potvrditVydat('${idSkupiny}')">VYDAT POUZE ZV√Å≈ΩEN√â</button>
                    </div>
                </div>`;
        }
    }

    function ulozVahu(prod, id, v) {
        db.ref("objednavky/" + prod + "/" + id).update({ skutecna_vaha_gr: parseInt(v) || 0 });
    }

    // HLAVN√ç OPRAVA: Vyd√°v√° jen to, co m√° v√°hu > 0
    function potvrditVydat(idSkupiny) {
        db.ref("objednavky").once("value", snapshot => {
            const data = snapshot.val();
            let celkovaCastka = 0;
            let seznamText = [];
            let jmenoZakaznika = "";
            let kAktualizaci = [];

            for (let prod in data) {
                for (let id in data[prod]) {
                    const o = data[prod][id];
                    const klic = o.id_skupiny || o.zakaznik;
                    
                    if (klic === idSkupiny && !o.vydano) {
                        const vGr = parseInt(o.skutecna_vaha_gr) || 0;

                        // POUZE POLO≈ΩKY S V√ÅHOU
                        if (vGr > 0) {
                            jmenoZakaznika = o.zakaznik;
                            const cKg = cenyZbozi[prod] || 0;
                            const cena = Math.round((vGr / 1000) * cKg);
                            
                            celkovaCastka += cena;
                            seznamText.push(`${prod} (${vGr}g)`);
                            kAktualizaci.push({ p: prod, i: id });
                        }
                    }
                }
            }

            if (kAktualizaci.length === 0) {
                alert("Napi≈°te v√°hu (v gramech) k polo≈æk√°m, kter√© chcete pr√°vƒõ teƒè vydat.");
                return;
            }

            // 1. Z√°pis do Nezaplaceno
            db.ref("nezaplaceno").push({
                jmeno: jmenoZakaznika,
                castka: celkovaCastka,
                zbozi: seznamText.join(", "),
                datum: new Date().toLocaleDateString(),
                id_skupiny: idSkupiny
            }).then(() => {
                // 2. Oznaƒçen√≠ vydan√Ωch kus≈Ø
                const sliby = kAktualizaci.map(item => {
                    return db.ref(`objednavky/${item.p}/${item.i}`).update({ vydano: true });
                });
                return Promise.all(sliby);
            }).then(() => {
                alert("Vydan√© polo≈æky byly odesl√°ny k platbƒõ. Zbytek z≈Øst√°v√° na kartƒõ.");
            });
        });
    }
</script>
</body>
</html>
