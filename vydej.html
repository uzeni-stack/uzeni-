<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>V√Ωdej - Spr√°va objedn√°vek</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --primary: #1a237e; --accent: #ff9800; --bg: #f4f7f9; --ready: #e8f5e9; --danger: #d32f2f; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 25px; }
        
        .karta { background: white; border-radius: 12px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border-top: 8px solid var(--accent); }
        .karta-hlavicka { display: flex; justify-content: space-between; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .jmeno { font-size: 1.4rem; font-weight: bold; color: var(--primary); }
        
        /* √öprava m≈ô√≠≈æky pro p≈ôid√°n√≠ tlaƒç√≠tka smazat */
        .radek { display: grid; grid-template-columns: 2fr 1fr 1.2fr 1fr 0.5fr; gap: 10px; padding: 12px 8px; border-bottom: 1px solid #f0f0f0; align-items: center; border-radius: 6px; }
        .radek.ma-vahu { background-color: var(--ready); border-left: 4px solid #4caf50; }
        
        input[type="number"] { width: 80px; padding: 8px; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-weight: bold; }
        
        .btn-vydat { background: var(--accent); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-storno-polozka { background: none; border: none; color: #ccc; cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
        .btn-storno-polozka:hover { color: var(--danger); }
        
        .btn-zrusit-vse { background: none; border: 1px solid #ffcdd2; color: #e57373; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; }
        .btn-zrusit-vse:hover { background: #ffebee; color: var(--danger); border-color: var(--danger); }

        .cena-polozka { text-align: right; font-weight: bold; color: #444; }
        .paticka { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 15px; border-top: 2px solid #eee; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0">üöö V√ùDEJ ZBO≈Ω√ç</h2>
    <a href="admin.html" style="text-decoration:none; font-weight:bold; color:var(--primary);">üè† ZPƒöT</a>
</div>

<div id="seznam-karet">Naƒç√≠t√°m objedn√°vky...</div>

<script>
    const firebaseConfig = { databaseURL: "https://eshop-fh-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let cenyZbozi = {};
    db.ref("produkty").on("value", s => { cenyZbozi = s.val() || {}; });

    db.ref("objednavky").on("value", snapshot => {
        if (document.activeElement.tagName === "INPUT") return;
        const data = snapshot.val() || {};
        const skupiny = {};
        let maNeco = false;

        for (let produkt in data) {
            for (let id in data[produkt]) {
                const obj = data[produkt][id];
                if (!obj.vydano) {
                    const klic = obj.id_skupiny || obj.zakaznik; 
                    if (!skupiny[klic]) {
                        skupiny[klic] = { jmeno: obj.zakaznik, datum: obj.datum, polozky: [] };
                    }
                    skupiny[klic].polozky.push({ ...obj, produkt: produkt, id: id });
                    maNeco = true;
                }
            }
        }
        vykresli(skupiny, maNeco);
    });

    function vykresli(skupiny, maNeco) {
        const div = document.getElementById("seznam-karet");
        div.innerHTML = "";
        if (!maNeco) { div.innerHTML = "<h3>V≈°e hotovo! ‚úÖ</h3>"; return; }

        for (let idSkupiny in skupiny) {
            const s = skupiny[idSkupiny];
            let radkyHtml = "";
            let sumaKarty = 0;

            s.polozky.forEach(p => {
                const vGr = parseInt(p.skutecna_vaha_gr) || 0;
                const cenaRadek = Math.round((vGr / 1000) * (cenyZbozi[p.produkt] || 0));
                sumaKarty += cenaRadek;

                radkyHtml += `
                    <div class="radek ${vGr > 0 ? 'ma-vahu' : ''}">
                        <div class="produkt-nazev">${p.produkt}</div>
                        <div style="color:#777; font-size:0.8rem">${p.vaha_objednano}kg</div>
                        <div>
                            <input type="number" value="${vGr || ''}" placeholder="0" 
                                onchange="ulozVahu('${p.produkt}','${p.id}', this.value)"> <small>gr</small>
                        </div>
                        <div class="cena-polozka">${cenaRadek} Kƒç</div>
                        <button class="btn-storno-polozka" title="Smazat tuto polo≈æku" 
                            onclick="smazatPolozku('${p.produkt}','${p.id}')">‚úï</button>
                    </div>`;
            });

            div.innerHTML += `
                <div class="karta">
                    <div class="karta-hlavicka">
                        <div class="jmeno">${s.jmeno}</div>
                        <button class="btn-zrusit-vse" onclick="smazatCelouSkupinu('${idSkupiny}')">Zru≈°it celou obj.</button>
                    </div>
                    ${radkyHtml}
                    <div class="paticka">
                        <div style="font-size:1.8rem; font-weight:900; color:var(--danger)">${sumaKarty} Kƒç</div>
                        <button class="btn-vydat" onclick="potvrditVydat('${idSkupiny}')">VYDAT ZV√Å≈ΩEN√â</button>
                    </div>
                </div>`;
        }
    }

    function ulozVahu(prod, id, v) {
        db.ref("objednavky/" + prod + "/" + id).update({ skutecna_vaha_gr: parseInt(v) || 0 });
    }

    // 1. SMAZ√ÅN√ç JEDN√â POLO≈ΩKY (ten k≈ô√≠≈æek)
    function smazatPolozku(produkt, id) {
        if (confirm("Opravdu smazat tuto polo≈æku z objedn√°vky?")) {
            db.ref(`objednavky/${produkt}/${id}`).remove();
        }
    }

    // 2. SMAZ√ÅN√ç CEL√â KARTY
    function smazatCelouSkupinu(idSkupiny) {
        if (!confirm("Chcete smazat kompletnƒõ celou objedn√°vku tohoto z√°kazn√≠ka?")) return;
        
        db.ref("objednavky").once("value", snap => {
            const data = snap.val();
            for (let prod in data) {
                for (let id in data[prod]) {
                    if ((data[prod][id].id_skupiny || data[prod][id].zakaznik) === idSkupiny) {
                        db.ref(`objednavky/${prod}/${id}`).remove();
                    }
                }
            }
        });
    }

    function potvrditVydat(idSkupiny) {
        db.ref("objednavky").once("value", snap => {
            const data = snap.val();
            let celkem = 0, seznam = [], kAktu = [], jmeno = "";
            for (let prod in data) {
                for (let id in data[prod]) {
                    const o = data[prod][id];
                    if ((o.id_skupiny || o.zakaznik) === idSkupiny && !o.vydano) {
                        const vGr = parseInt(o.skutecna_vaha_gr) || 0;
                        if (vGr > 0) {
                            jmeno = o.zakaznik;
                            celkem += Math.round((vGr / 1000) * (cenyZbozi[prod] || 0));
                            seznam.push(`${prod} (${vGr}g)`);
                            kAktu.push({ p: prod, i: id });
                        }
                    }
                }
            }
            if (kAktu.length === 0) { alert("Zadej gramy!"); return; }
            db.ref("nezaplaceno").push({
                jmeno: jmeno, castka: celkem, zbozi: seznam.join(", "),
                datum: new Date().toLocaleDateString(), id_skupiny: idSkupiny
            }).then(() => {
                kAktu.forEach(item => db.ref(`objednavky/${item.p}/${item.i}`).update({ vydano: true }));
                alert("Vyd√°no!");
            });
        });
    }
</script>
</body>
</html>
