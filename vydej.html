<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>V√ùDEJ ZBO≈Ω√ç</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        .hlavicka { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .karta { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-left: 10px solid #ff9800; margin-bottom: 20px; }
        .radek { display: grid; grid-template-columns: 2fr 1fr 1.5fr 1fr; gap: 10px; border-bottom: 1px solid #eee; padding: 10px 0; align-items: center; }
        input { width: 70px; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-weight: bold; text-align: center; }
        .btn-vydat { background: #ff9800; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem; }
        .btn-vydat:hover { background: #e68a00; }
        .suma { font-size: 1.5rem; font-weight: bold; color: #d32f2f; }
        .zpet { text-decoration: none; color: #1a237e; font-weight: bold; border: 1px solid #1a237e; padding: 5px 10px; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="hlavicka">
        <h2 style="margin:0">üöö Aktu√°ln√≠ v√Ωdej (Karty)</h2>
        <a href="admin.html" class="zpet">üè† ZPƒöT DO ADMINA</a>
    </div>

    <div id="seznam-karet">
        <p style="text-align:center">ƒåek√°m na data z Firebase...</p>
    </div>

<script>
    // TVOJE KONFIGURACE (Zkontroluj, jestli sed√≠ URL)
    const firebaseConfig = { 
        databaseURL: "https://eshop-fh-default-rtdb.europe-west1.firebasedatabase.app" 
    };
    
    // Inicializace
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    let ceny = {};

    // 1. Naƒçten√≠ cen produkt≈Ø
    db.ref("produkty").on("value", snapshot => {
        ceny = snapshot.val() || {};
        console.log("Ceny naƒçteny:", ceny);
    });

    // 2. Naƒçten√≠ a zobrazen√≠ objedn√°vek
    db.ref("objednavky").on("value", snapshot => {
        // Pokud zrovna p√≠≈°e≈°, nep≈ôekreslovat
        if (document.activeElement.tagName === "INPUT") return;

        const data = snapshot.val() || {};
        const lide = {};
        let maNeco = false;

        // Rozt≈ô√≠dit data podle jmen
        for (let produkt in data) {
            for (let id in data[produkt]) {
                const obj = data[produkt][id];
                if (!obj.vydano) {
                    const jm = obj.zakaznik || "Nezn√°m√© jm√©no";
                    if (!lide[jm]) lide[jm] = [];
                    lide[jm].push({ ...obj, produkt: produkt, id: id });
                    maNeco = true;
                }
            }
        }

        const kontejner = document.getElementById("seznam-karet");
        kontejner.innerHTML = "";

        if (!maNeco) {
            kontejner.innerHTML = "<div class='karta' style='text-align:center'><h3>≈Ω√°dn√© objedn√°vky k v√Ωdeji.</h3></div>";
            return;
        }

        // Vykreslit ka≈æd√©ho ƒçlovƒõka jako kartu
        for (let jmeno in lide) {
            let radkyHtml = "";
            let celkem = 0;

            lide[jmeno].forEach(p => {
                const cKg = ceny[p.produkt] || 0;
                const vGr = p.skutecna_vaha_gr || 0;
                const radekCena = Math.round((vGr / 1000) * cKg);
                celkem += radekCena;

                radkyHtml += `
                    <div class="radek">
                        <div style="font-weight:bold">${p.produkt}</div>
                        <div style="color:#666; font-size:0.8rem">Obj: ${p.vaha_objednano}kg</div>
                        <div>
                            <input type="number" value="${vGr}" onchange="ulozVahu('${p.produkt}','${p.id}', this.value)"> <small>gr</small>
                        </div>
                        <div style="text-align:right; font-weight:bold">${radekCena} Kƒç</div>
                    </div>`;
            });

            kontejner.innerHTML += `
                <div class="karta">
                    <div style="font-size:1.2rem; font-weight:bold; border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:10px">${jmeno}</div>
                    ${radkyHtml}
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px">
                        <div class="suma">${celkem} Kƒç</div>
                        <button class="btn-vydat" onclick="vydatZbozi('${jmeno.replace(/'/g, "\\'")}')">VYDAT ZBO≈Ω√ç ‚úÖ</button>
                    </div>
                </div>`;
        }
    });

    // Funkce pro okam≈æit√© ulo≈æen√≠ gram≈Ø
    function ulozVahu(prod, id, v) {
        db.ref("objednavky/" + prod + "/" + id).update({
            skutecna_vaha_gr: parseInt(v) || 0
        });
    }

    // Funkce pro potvrzen√≠ v√Ωdeje a p≈ôesun do Nezaplaceno
    function vydatZbozi(jmeno) {
        db.ref("objednavky").once("value", snapshot => {
            const data = snapshot.val();
            let suma = 0;
            let soupis = [];

            for (let prod in data) {
                for (let id in data[prod]) {
                    const o = data[prod][id];
                    if (o.zakaznik === jmeno && !o.vydano) {
                        const cKg = ceny[prod] || 0;
                        const vGr = o.skutecna_vaha_gr || 0;
                        suma += Math.round((vGr / 1000) * cKg);
                        soupis.push(prod + " (" + vGr + "g)");
                        
                        // Oznaƒçit jako vydan√©
                        db.ref("objednavky/" + prod + "/" + id).update({ vydano: true });
                    }
                }
            }

            // Z√°pis do Nezaplaceno
            db.ref("nezaplaceno").push({
                jmeno: jmeno,
                castka: suma,
                zbozi: soupis.join(", "),
                datum: new Date().toLocaleDateString()
            });

            alert("Vyd√°no! Z√°kazn√≠k " + jmeno + " byl p≈ôesunut do sekce NEZAPLACENO.");
        });
    }
</script>
</body>
</html>
