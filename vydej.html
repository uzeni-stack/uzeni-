<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V√Ωdej - Karty z√°kazn√≠k≈Ø</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --primary: #1a237e; --vydej: #ff6f00; --bg: #f0f2f5; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 0; }
        
        /* Horn√≠ li≈°ta */
        .header { 
            background: white; padding: 10px 20px; border-bottom: 2px solid #ccc; 
            display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; z-index: 1000; 
        }

        .container { max-width: 850px; margin: 20px auto; padding: 0 15px; }
        
        .karta-zakaznik { 
            background: white; border-radius: 10px; padding: 15px; 
            margin-bottom: 20px; box-shadow: 0 3px 6px rgba(0,0,0,0.1); 
            border-left: 8px solid var(--vydej); 
        }

        .jmeno-hlava { font-size: 1.3rem; font-weight: 800; color: #111; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 10px; text-transform: uppercase; }

        /* Tabulkov√Ω vzhled polo≈æek */
        .polozka { 
            display: grid; 
            grid-template-columns: 2fr 1fr 1.2fr 100px; 
            gap: 10px; align-items: center; padding: 8px 0;
            border-bottom: 1px solid #f1f1f1;
        }

        .nazev-zbozi { font-weight: bold; font-size: 1rem; }
        .vaha-obj { color: #666; font-size: 0.85rem; }
        
        .vstup-gramy { display: flex; align-items: center; gap: 5px; }
        .vstup-gramy input { 
            width: 70px; padding: 6px; border: 2px solid #ddd; 
            border-radius: 6px; text-align: center; font-weight: bold; font-size: 1rem;
        }

        .cena-radek { text-align: right; font-weight: 800; color: #d32f2f; font-size: 1.1rem; }

        /* Patiƒçka karty */
        .paticka { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-top: 15px; padding-top: 15px; border-top: 2px solid #eee; 
        }
        .celkova-cena { font-size: 1.6rem; font-weight: 900; color: #d32f2f; }
        
        .btn-vydat { 
            background: var(--vydej); color: white; border: none; 
            padding: 12px 25px; border-radius: 8px; font-weight: bold; 
            cursor: pointer; font-size: 1rem; transition: 0.2s;
        }
        .btn-vydat:hover { background: #e65100; transform: scale(1.02); }

        .btn-zpet { background: var(--primary); color: white; text-decoration: none; padding: 8px 15px; border-radius: 6px; font-weight: bold; font-size: 0.85rem; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0; color:var(--vydej);">üöö V√ùDEJ ZBO≈Ω√ç</h2>
    <a href="admin.html" class="btn-zpet">üè† ZPƒöT DO ADMINU</a>
</div>

<div class="container" id="seznam-karet">
    <div style="text-align:center; padding:50px; color:#666;">Naƒç√≠t√°m objedn√°vky a propojuji s v√°hou...</div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://eshop-fh-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let cenyProduktu = {};

    // 1. Nejprve naƒçteme ceny, abychom mohli poƒç√≠tat
    db.ref("produkty").on("value", (snap) => {
        cenyProduktu = snap.val() || {};
        nactiObjednavky();
    });

    // 2. Naƒçten√≠ objedn√°vek a seskupen√≠ podle lid√≠
    function nactiObjednavky() {
        db.ref("objednavky").on("value", (snapshot) => {
            // Pokud u≈æivatel pr√°vƒõ p√≠≈°e do pol√≠ƒçka, nebudeme mu to p≈ôekreslovat pod rukama
            if (document.activeElement.tagName === "INPUT") return;

            const data = snapshot.val() || {};
            const lide = {};
            let existujeNeco = false;

            for (let produkt in data) {
                for (let id in data[produkt]) {
                    const obj = data[produkt][id];
                    
                    // Zobraz√≠me jen ty, kter√© je≈°tƒõ NEJSOU vydan√©
                    if (!obj.vydano) {
                        const jm = obj.zakaznik || "Anonymn√≠";
                        if (!lide[jm]) lide[jm] = { polozky: [] };
                        
                        lide[jm].polozky.push({
                            ...obj,
                            produkt: produkt,
                            id: id
                        });
                        existujeNeco = true;
                    }
                }
            }

            vykresli(lide);
        });
    }

    // 3. Vykreslen√≠ karet na obrazovku
    function vykresli(lide) {
        const kontejner = document.getElementById("seznam-karet");
        kontejner.innerHTML = "";

        if (Object.keys(lide).length === 0) {
            kontejner.innerHTML = "<div style='text-align:center; padding:50px;'><h3>V≈°echno je vyd√°no! ‚úÖ</h3></div>";
            return;
        }

        for (let jm in lide) {
            let htmlPolozky = "";
            let celkovaSumaKarty = 0;
            let seznamZboziText = [];

            lide[jm].polozky.forEach(p => {
                const cenaKg = cenyProduktu[p.produkt] || 0;
                const vahaGr = p.skutecna_vaha_gr || 0;
                const vypocetCeny = Math.round((vahaGr / 1000) * cenaKg);
                celkovaSumaKarty += vypocetCeny;
                
                if (vahaGr > 0) {
                    seznamZboziText.push(`${p.produkt} (${vahaGr}g)`);
                }

                htmlPolozky += `
                    <div class="polozka">
                        <div class="nazev-zbozi">${p.produkt}</div>
                        <div class="vaha-obj">Obj: ${p.vaha_objednano} kg</div>
                        <div class="vstup-gramy">
                            <input type="number" 
                                   value="${vahaGr || ''}" 
                                   placeholder="0"
                                   onchange="ulozVahu('${p.produkt}','${p.id}', this.value)">
                            <span>gr</span>
                        </div>
                        <div class="cena-radek">${vypocetCeny} Kƒç</div>
                    </div>`;
            });

            kontejner.innerHTML += `
                <div class="karta-zakaznik">
                    <div class="jmeno-hlava">${jm}</div>
                    ${htmlPolozky}
                    <div class="paticka">
                        <div class="celkova-cena">${celkovaSumaKarty} Kƒç</div>
                        <button class="btn-vydat" onclick="potvrditVydano('${jm}', ${celkovaSumaKarty}, '${seznamZboziText.join(', ')}', ${JSON.stringify(lide[jm].polozky)})">
                            VYD√ÅNO (K PLATBƒö)
                        </button>
                    </div>
                </div>`;
        }
    }

    // 4. Ukl√°d√°n√≠ v√°hy do datab√°ze (p≈ôi ka≈æd√© zmƒõnƒõ)
    function ulozVahu(prod, id, v) {
        db.ref("objednavky/" + prod + "/" + id).update({
            skutecna_vaha_gr: parseInt(v) || 0
        });
    }

    // 5. Hlavn√≠ funkce: P≈ôesun do Nezaplaceno a skryt√≠ z V√Ωdeje
    function potvrditVydano(jm, castka, textZbozi, polozky) {
        if (castka <= 0) {
            alert("Nejd≈ô√≠ve vypl≈àte skuteƒçnou v√°hu u produkt≈Ø!");
            return;
        }

        // A) Z√°znam do slo≈æky nezaplaceno
        db.ref("nezaplaceno").push({
            jmeno: jm,
            castka: castka,
            zbozi: textZbozi,
            datum: new Date().toLocaleDateString()
        });

        // B) Oznaƒçit polo≈æky v objedn√°vk√°ch za vydan√© (zmiz√≠ z t√©to str√°nky)
        polozky.forEach(p => {
            db.ref("objednavky/" + p.produkt + "/" + p.id).update({
                vydano: true
            });
        });

        alert("Vyd√°no! Z√°kazn√≠k se p≈ôesunul do sekce NEZAPLACENO.");
    }
</script>

</body>
</html>
