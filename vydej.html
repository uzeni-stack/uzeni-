<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>V√Ωdejn√≠ karty - Opraven√° verze</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --primary: #1a237e; --accent: #ff9800; --bg: #f4f7f9; --ready: #e8f5e9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 25px; }
        
        .karta { background: white; border-radius: 12px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border-top: 8px solid var(--accent); }
        .karta-hlavicka { display: flex; justify-content: space-between; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .jmeno { font-size: 1.4rem; font-weight: bold; color: var(--primary); }
        
        .radek { display: grid; grid-template-columns: 2fr 1fr 1.5fr 1fr; gap: 15px; padding: 12px 8px; border-bottom: 1px solid #f0f0f0; align-items: center; border-radius: 6px; }
        /* Zelen√Ω podbarven√Ω ≈ô√°dek, kdy≈æ jsou zad√°ny gramy */
        .radek.ma-vahu { background-color: var(--ready); border-left: 4px solid #4caf50; }
        
        input[type="number"] { width: 85px; padding: 8px; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-weight: bold; font-size: 1.1rem; }
        input:focus { border-color: var(--accent); outline: none; }

        .cena-polozka { text-align: right; font-weight: bold; color: #444; }
        .paticka { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 15px; border-top: 2px solid #eee; }
        .celkem-suma { font-size: 1.8rem; font-weight: 900; color: #d32f2f; }
        
        .btn-vydat { background: var(--accent); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-vydat:hover { background: #e68a00; }
        .btn-zpet { text-decoration: none; color: var(--primary); font-weight: bold; padding: 10px; border: 1px solid var(--primary); border-radius: 6px; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0">üöö V√ùDEJ ZBO≈Ω√ç</h2>
    <a href="admin.html" class="btn-zpet">üè† ZPƒöT</a>
</div>

<div id="seznam-karet">Naƒç√≠t√°m...</div>

<script>
    const firebaseConfig = { databaseURL: "https://eshop-fh-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let cenyZbozi = {};

    // 1. Naƒçten√≠ cen
    db.ref("produkty").on("value", s => { cenyZbozi = s.val() || {}; });

    // 2. Naƒçten√≠ a seskupen√≠
    db.ref("objednavky").on("value", snapshot => {
        if (document.activeElement.tagName === "INPUT") return;
        const data = snapshot.val() || {};
        const skupiny = {};
        let maNeco = false;

        for (let produkt in data) {
            for (let id in data[produkt]) {
                const obj = data[produkt][id];
                if (!obj.vydano) {
                    const klic = obj.id_skupiny || obj.zakaznik; 
                    if (!skupiny[klic]) {
                        skupiny[klic] = { jmeno: obj.zakaznik, datum: obj.datum, polozky: [] };
                    }
                    skupiny[klic].polozky.push({ ...obj, produkt: produkt, id: id });
                    maNeco = true;
                }
            }
        }
        vykresli(skupiny, maNeco);
    });

    function vykresli(skupiny, maNeco) {
        const div = document.getElementById("seznam-karet");
        div.innerHTML = "";
        if (!maNeco) { div.innerHTML = "<h3>V≈°e hotovo! ‚úÖ</h3>"; return; }

        for (let idSkupiny in skupiny) {
            const s = skupiny[idSkupiny];
            let radkyHtml = "";
            let sumaKarty = 0;

            s.polozky.forEach(p => {
                const cKg = cenyZbozi[p.produkt] || 0;
                const vGr = parseInt(p.skutecna_vaha_gr) || 0;
                const cenaRadek = Math.round((vGr / 1000) * cKg);
                sumaKarty += cenaRadek;

                radkyHtml += `
                    <div class="radek ${vGr > 0 ? 'ma-vahu' : ''}">
                        <div class="produkt-nazev">${p.produkt}</div>
                        <div style="color:#777; font-size:0.8rem">Obj: ${p.vaha_objednano}kg</div>
                        <div>
                            <input type="number" value="${vGr || ''}" placeholder="0" 
                                onchange="ulozVahu('${p.produkt}','${p.id}', this.value)"> <small>gr</small>
                        </div>
                        <div class="cena-polozka">${cenaRadek} Kƒç</div>
                    </div>`;
            });

            div.innerHTML += `
                <div class="karta">
                    <div class="karta-hlavicka">
                        <div class="jmeno">${s.jmeno}</div>
                        <div style="color:#888; font-size:0.8rem">${s.datum || ''}</div>
                    </div>
                    ${radkyHtml}
                    <div class="paticka">
                        <div class="celkem-suma">${sumaKarty} Kƒç</div>
                        <button class="btn-vydat" onclick="potvrditVydat('${idSkupiny}')">VYDAT ZV√Å≈ΩEN√â</button>
                    </div>
                </div>`;
        }
    }

    function ulozVahu(prod, id, v) {
        db.ref("objednavky/" + prod + "/" + id).update({ skutecna_vaha_gr: parseInt(v) || 0 });
    }

    function potvrditVydat(idSkupiny) {
        db.ref("objednavky").once("value", snap => {
            const data = snap.val();
            let celkem = 0, seznam = [], kAktu = [], jmeno = "";

            for (let prod in data) {
                for (let id in data[prod]) {
                    const o = data[prod][id];
                    if ((o.id_skupiny || o.zakaznik) === idSkupiny && !o.vydano) {
                        const vGr = parseInt(o.skutecna_vaha_gr) || 0;
                        if (vGr > 0) {
                            jmeno = o.zakaznik;
                            const cena = Math.round((vGr / 1000) * (cenyZbozi[prod] || 0));
                            celkem += cena;
                            seznam.push(`${prod} (${vGr}g)`);
                            kAktu.push({ p: prod, i: id });
                        }
                    }
                }
            }

            if (kAktu.length === 0) { alert("Zadej gramy!"); return; }

            db.ref("nezaplaceno").push({
                jmeno: jmeno, castka: celkem, zbozi: seznam.join(", "),
                datum: new Date().toLocaleDateString(), id_skupiny: idSkupiny
            }).then(() => {
                kAktu.forEach(item => db.ref(`objednavky/${item.p}/${item.i}`).update({ vydano: true }));
                alert("Odesl√°no k platbƒõ!");
            });
        });
    }
</script>
</body>
</html>
