<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Historie & Bilance z Firebase</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --primary: #1a237e; --bg: #f4f7f9; --danger: #d32f2f; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        .top-panel { display: flex; gap: 20px; align-items: flex-start; margin-bottom: 20px; flex-wrap: wrap; }
        .search-box { padding: 12px; border: 2px solid #ddd; border-radius: 8px; width: 250px; font-size: 1rem; }

        .bilance-box { 
            background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            flex-grow: 1; display: flex; flex-wrap: wrap; gap: 10px; 
        }

        .bilance-item { 
            padding: 8px 15px; border-radius: 20px; font-weight: bold; 
            display: flex; align-items: center; gap: 8px; border: 2px solid #ddd;
            background: #f5f5f5; color: #444;
        }

        /* Dynamick칠 barvy, kter칠 p콏i콏ad칤me p콏es JS */
        .badge-count { background: white; padding: 2px 8px; border-radius: 10px; font-size: 1.1rem; box-shadow: inset 0 0 5px rgba(0,0,0,0.1); }

        .zakaznik-karta { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .jmeno { font-size: 1.4rem; font-weight: bold; color: var(--primary); }
        .historie-tabulka { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .historie-tabulka th { text-align: left; padding: 8px; border-bottom: 1px solid #ddd; color: #666; }
        .historie-tabulka td { padding: 10px 8px; border-bottom: 1px solid #f9f9f9; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0">游늵 콯IV츼 BILANCE PRODEJE</h2>
    <a href="admin.html" style="text-decoration:none; font-weight:bold; color:var(--primary);">游 ADMIN</a>
</div>

<div class="top-panel">
    <input type="text" id="hledat" class="search-box" placeholder="Hledat z치kazn칤ka..." onkeyup="filtruj()">
    <div id="bilance-zbozi" class="bilance-box">Na캜칤t치m produkty z datab치ze...</div>
</div>

<div id="seznam-historie"></div>

<script>
    const firebaseConfig = { databaseURL: "https://eshop-fh-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let seznamProduktu = {}; // Sem si ulo쮂셠e barvy a n치zvy z Firebase

    // 1. KROK: Na캜ten칤 produkt콢 pro barvy
    db.ref("produkty").on("value", snapshot => {
        seznamProduktu = snapshot.val() || {};
        nactiHistorii(); // Jakmile m치me produkty, na캜teme historii
    });

    // 2. KROK: Na캜ten칤 historie a v칳po캜et
    function nactiHistorii() {
        db.ref("finance").on("value", snap => {
            const data = snap.val() || {};
            const zakaznici = {};
            const bilance = {};

            for (let mesic in data) {
                if (data[mesic].trzby) {
                    for (let id in data[mesic].trzby) {
                        const t = data[mesic].trzby[id];
                        
                        // S캜칤t치n칤 do bilance
                        bilance[t.zbozi] = (bilance[t.zbozi] || 0) + 1;

                        // T콏칤d캩n칤 k z치kazn칤k콢m
                        if (!zakaznici[t.zakaznik]) zakaznici[t.zakaznik] = [];
                        zakaznici[t.zakaznik].push({...t, id, mesic});
                    }
                }
            }
            vykresliBilanci(bilance);
            vykresliZakazniky(zakaznici);
        });
    }

    function vykresliBilanci(bilance) {
        const box = document.getElementById("bilance-zbozi");
        box.innerHTML = "";

        Object.keys(bilance).sort().forEach(zbozi => {
            let styl = "background: #f5f5f5; color: #444; border-color: #999;"; // Z치kladn칤 코ed치
            
            // Hled치n칤 barvy v seznamu produkt콢
            if (zbozi.toLowerCase().includes("klob치sa") || zbozi.toLowerCase().includes("klobasa")) {
                styl = "background: #e8f5e9; color: #2e7d32; border-color: #2e7d32;";
            } else if (zbozi.toLowerCase().includes("캜abajka") || zbozi.toLowerCase().includes("cabajka")) {
                styl = "background: #e3f2fd; color: #1565c0; border-color: #1565c0;";
            }

            box.innerHTML += `
                <div class="bilance-item" style="${styl}">
                    ${zbozi} <span class="badge-count">${bilance[zbozi]}x</span>
                </div>`;
        });
    }

    function vykresliZakazniky(zakaznici) {
        const kontejner = document.getElementById("seznam-historie");
        kontejner.innerHTML = "";
        Object.keys(zakaznici).sort().forEach(jmeno => {
            let utrata = 0;
            let radky = zakaznici[jmeno].reverse().map(n => {
                utrata += parseInt(n.castka);
                return `<tr><td>${n.datum}</td><td>${n.zbozi}</td><td><b>${n.castka} K캜</b></td></tr>`;
            }).join("");

            kontejner.innerHTML += `
                <div class="zakaznik-karta" data-jmeno="${jmeno.toLowerCase()}">
                    <div style="display:flex; justify-content:space-between">
                        <span class="jmeno">${jmeno}</span>
                        <span>Celkem: <b>${utrata} K캜</b></span>
                    </div>
                    <table class="historie-tabulka">
                        <thead><tr><th>Datum</th><th>Zbo쮂</th><th>캛치stka</th></tr></thead>
                        <tbody>${radky}</tbody>
                    </table>
                </div>`;
        });
    }

    function filtruj() {
        const t = document.getElementById("hledat").value.toLowerCase();
        document.querySelectorAll(".zakaznik-karta").forEach(k => {
            k.style.display = k.getAttribute("data-jmeno").includes(t) ? "block" : "none";
        });
    }
</script>
</body>
</html>
