<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOOS - KOMPLETN칈 SYST칄M</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; padding: 15px; line-height: 1.5; }
        .section { background: white; border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #ddd; }
        
        /* Barvy sekc칤 */
        .blue-box { border-left: 8px solid #00acc1; background: #e0f7fa; } /* Ekonomika */
        .red-box { border-left: 8px solid #d32f2f; background: #ffebee; }  /* Dlu쬹칤ci */
        .green-box { border-left: 8px solid #2e7d32; background: #e8f5e9; } /* Sum치콏 */
        .main-box { border-top: 5px solid #1976d2; } /* V치쬰n칤 */

        h3 { margin-top: 0; display: flex; justify-content: space-between; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-size: 12px; text-transform: uppercase; }

        input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .input-vaha { width: 80px; font-weight: bold; border-color: #1976d2; }
        .input-pay { width: 80px; font-weight: bold; background: #fffde7; }
        
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-save { background: #2e7d32; color: white; }
        .btn-cost { background: #455a64; color: white; }
        
        .val-red { color: #d32f2f; font-weight: bold; }
        .val-green { color: #2e7d32; font-weight: bold; }
    </style>
</head>
<body>

    <div class="section blue-box">
        <h3>游눯 EKONOMIKA A N츼KLADY</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
            <div>TR콯BY: <span id="stat-trzby" class="val-green">0 K캜</span></div>
            <div>N츼KLADY: <span id="stat-naklady" class="val-red">0 K캜</span></div>
            <div>ZISK: <span id="stat-zisk" style="font-size:1.2em; font-weight:bold;">0 K캜</span></div>
        </div>
        <div style="margin-top:15px; border-top: 1px solid #b2ebf2; padding-top:10px;">
            <input type="number" id="novy-naklad" placeholder="캛치stka n치kladu">
            <button class="btn btn-cost" onclick="pridejNaklad()">P콎IDAT V칗DAJ</button>
        </div>
    </div>

    <div id="box-dluznici" class="section red-box" style="display:none;">
        <h3 class="val-red">丘멆잺 SEZNAM DLU콯N칈K콡</h3>
        <div id="seznam-dluhy"></div>
    </div>

    <div id="box-sumar" class="section green-box">
        <h3>游논 CELKEM K PLATB캨 PODLE JM칄N</h3>
        <table id="tab-sumar">
            <thead><tr><th>Z치kazn칤k</th><th>Polo쬰k</th><th>Cena celkem</th><th>Zaplaceno</th><th>Zb칳v치</th></tr></thead>
            <tbody id="vystup-sumar"></tbody>
        </table>
    </div>

    <div id="vystup-zbozi"></div>

    <div class="section" style="background:#f5f5f5;">
        <h3>游늳 CELKEM PROD츼NO (KILOGRAMY)</h3>
        <div id="vystup-vahy"></div>
        <button onclick="resetStats()" style="color:red; background:none; border:none; cursor:pointer; font-size:11px; margin-top:10px;">Vynulovat statistiky (konec roku)</button>
    </div>

<script>
    const firebaseConfig = { databaseURL: "https://eshop-fh-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let cenyZbozi = {};

    db.ref("produkty").on("value", (snap) => {
        cenyZbozi = snap.val() || {};
        nactiData();
    });

    function nactiData() {
        // Na캜ten칤 statistik
        db.ref("statistiky").on("value", (snap) => {
            const s = snap.val() || {};
            const trzby = s.celkove_trzby || 0;
            const naklady = s.celkove_naklady || 0;
            document.getElementById("stat-trzby").innerText = trzby + " K캜";
            document.getElementById("stat-naklady").innerText = naklady + " K캜";
            document.getElementById("stat-zisk").innerText = (trzby - naklady) + " K캜";
            
            let vHtml = "<ul>";
            for (let k in s.vahy) { vHtml += `<li>${k}: <b>${(s.vahy[k]/1000).toFixed(2)} kg</b></li>`; }
            document.getElementById("vystup-vahy").innerHTML = vHtml + "</ul>";
        });

        // Na캜ten칤 objedn치vek
        db.ref("objednavky").on("value", (snap) => {
            const data = snap.val();
            const divZbozi = document.getElementById("vystup-zbozi");
            const divSumar = document.getElementById("vystup-sumar");
            const divDluhy = document.getElementById("seznam-dluhy");
            const boxDluhy = document.getElementById("box-dluznici");

            divZbozi.innerHTML = ""; divSumar.innerHTML = ""; divDluhy.innerHTML = "";
            if (!data) return;

            let poJmenech = {}; let poZbozi = {}; let dluzniciCount = 0;

            for (let id in data) {
                let o = data[id]; o.id = id;
                let c = o.skutecna_cena || 0;
                let z = o.zaplaceno || 0;

                // Seskupen칤
                if (!poJmenech[o.zakaznik]) poJmenech[o.zakaznik] = { ks:0, cena:0, zaplaceno:0 };
                poJmenech[o.zakaznik].ks++;
                poJmenech[o.zakaznik].cena += c;
                poJmenech[o.zakaznik].zaplaceno += z;

                if (!poZbozi[o.produkty]) poZbozi[o.produkty] = [];
                poZbozi[o.produkty].push(o);

                // Kontrola dluhu
                if (c > 0 && z < c) {
                    dluzniciCount++;
                    divDluhy.innerHTML += `<div><b>${o.zakaznik}</b> dlu쮂 <span class="val-red">${c-z} K캜</span> za ${o.produkty}</div>`;
                }
            }
            boxDluhy.style.display = dluzniciCount > 0 ? "block" : "none";

            // Vykreslen칤 sum치콏e
            for (let jm in poJmenech) {
                let p = poJmenech[jm]; let zb = p.cena - p.zaplaceno;
                divSumar.innerHTML += `<tr><td><b>${jm}</b></td><td>${p.ks}</td><td>${p.cena} K캜</td><td>${p.zaplaceno} K캜</td><td class="${zb>0?'val-red':'val-green'}">${zb} K캜</td></tr>`;
            }

            // Vykreslen칤 tabulek zbo쮂
            for (let prod in poZbozi) {
                let cenaKg = cenyZbozi[prod] || 0;
                let html = `<div class="section main-box"><h3>游닍 ${prod} <small style="font-weight:normal; font-size:12px;">(${cenaKg} K캜/kg)</small></h3><table>
                    <thead><tr><th>Z치kazn칤k</th><th>V치ha (gr)</th><th>Cena</th><th>Zaplaceno</th><th>Akce</th></tr></thead><tbody>`;
                
                poZbozi[prod].forEach(obj => {
                    html += `<tr>
                        <td><b>${obj.zakaznik}</b><br><small>Objedn치no: ${obj.vaha}kg</small></td>
                        <td><input type="number" class="input-vaha" value="${obj.skutecna_vaha_gr||''}" oninput="prepocet('${obj.id}', this.value, ${cenaKg})" id="gr-${obj.id}"></td>
                        <td id="disp-${obj.id}" style="font-weight:bold;">${obj.skutecna_cena || 0} K캜</td>
                        <td><input type="number" class="input-pay" value="${obj.zaplaceno||0}" id="pay-${obj.id}"></td>
                        <td><button class="btn btn-save" onclick="uloz('${obj.id}', ${cenaKg}, '${prod}')">ULO콯IT</button></td>
                    </tr>`;
                });
                divZbozi.innerHTML += html + `</tbody></table></div>`;
            }
        });
    }

    function prepocet(id, gr, cenaKg) {
        document.getElementById("disp-" + id).innerText = Math.round((gr / 1000) * cenaKg) + " K캜";
    }

    function uloz(id, cenaKg, prod) {
        const gr = parseInt(document.getElementById("gr-"+id).value) || 0;
        const pay = parseInt(document.getElementById("pay-"+id).value) || 0;
        const cena = Math.round((gr / 1000) * cenaKg);

        db.ref("objednavky/" + id).once("value").then((snap) => {
            const d = snap.val();
            const rozdilVaha = gr - (d.skutecna_vaha_gr || 0);
            const rozdilTrzba = pay - (d.zaplaceno || 0);

            db.ref("objednavky/" + id).update({ skutecna_vaha_gr: gr, skutecna_cena: cena, zaplaceno: pay });
            if (rozdilVaha !== 0) db.ref("statistiky/vahy/" + prod).transaction(c => (c || 0) + rozdilVaha);
            if (rozdilTrzba !== 0) db.ref("statistiky/celkove_trzby").transaction(c => (c || 0) + rozdilTrzba);
            alert("Ulo쬰no!");
        });
    }

    function pridejNaklad() {
        const castka = parseInt(document.getElementById("novy-naklad").value) || 0;
        if (castka > 0) {
            db.ref("statistiky/celkove_naklady").transaction(c => (c || 0) + castka);
            document.getElementById("novy-naklad").value = "";
            alert("N치klad zaps치n.");
        }
    }

    function resetStats() {
        if (confirm("SMAZAT VECHNY STATISTIKY ROKU?")) db.ref("statistiky").remove();
    }
</script>
</body>
</html>
