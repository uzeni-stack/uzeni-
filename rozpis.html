<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokladna Boos - Ekonomika</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 10px; margin: 0; }
        .container { max-width: 1000px; margin: auto; }
        .sumar-box { background: #e8f5e9; border: 2px solid #2e7d32; border-radius: 15px; padding: 15px; margin-bottom: 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .zbozi-sekce { background: white; margin-bottom: 20px; border-radius: 12px; border: 1px solid #1976d2; overflow: hidden; }
        .zbozi-hlavicka { background: #1976d2; color: white; padding: 10px 15px; font-weight: bold; display: flex; justify-content: space-between; }
        .stats-box { background: #cfd8dc; border: 2px solid #455a64; border-radius: 15px; padding: 15px; margin-top: 40px; }
        .ekonomika-box { background: #e0f7fa; border: 2px solid #00acc1; border-radius: 15px; padding: 15px; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        td, th { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        .input-vaha { width: 70px; padding: 8px; border: 1px solid #1976d2; border-radius: 5px; font-weight: bold; }
        .btn-save { background: #2e7d32; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .dluh { color: red; font-weight: bold; }
        .zisk-kladny { color: #2e7d32; font-weight: bold; font-size: 1.2em; }
        .zisk-zaporny { color: #d32f2f; font-weight: bold; font-size: 1.2em; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center;">游늵 POKLADNA A V츼콯EN칈</h2>

    <div class="ekonomika-box">
        <h3 style="margin-top:0; color:#006064;">游눯 EKONOMIKA ROKU</h3>
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div>Tr쬭y celkem: <span id="stat-trzby" style="font-weight:bold; color:green;">0 K캜</span></div>
            <div>N치klady celkem: <span id="stat-naklady" style="font-weight:bold; color:red;">0 K캜</span></div>
            <div>캛ist칳 zisk: <span id="stat-zisk">0 K캜</span></div>
        </div>
        <hr style="border: 0; border-top: 1px solid #b2ebf2; margin: 15px 0;">
        <div>
            <input type="number" id="novy-naklad" placeholder="캛치stka n치kladu (K캜)" style="padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
            <button onclick="pridejNaklad()" style="padding: 8px 15px; background: #00acc1; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">P콎IDAT V칗DAJ</button>
        </div>
    </div>

    <div id="vypis-sumar-root"></div>

    <div id="vypis-zbozi">Na캜칤t치m objedn치vky...</div>

    <div class="stats-box">
        <h3 style="margin-top:0;">游늳 CELKEM PROD츼NO (KILOGRAMY)</h3>
        <div id="vypis-statistiky">Zat칤m pr치zdno...</div>
        <button onclick="resetStats()" style="margin-top:20px; color:red; cursor:pointer; background:none; border:1px solid red; padding:5px; border-radius:5px;">Resetovat v코e (konec roku)</button>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://eshop-fh-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let cenyZbozi = {};

    db.ref("produkty").on("value", (snap) => {
        cenyZbozi = snap.val() || {};
        nactiData();
        nactiStatistiky();
    });

    function nactiData() {
        db.ref("objednavky").on("value", (snap) => {
            const data = snap.val();
            const divZbozi = document.getElementById("vypis-zbozi");
            const divSumarRoot = document.getElementById("vypis-sumar-root");
            
            if (!data) { 
                divZbozi.innerHTML = "<p>콯치dn칠 aktivn칤 objedn치vky k v치쬰n칤.</p>"; 
                divSumarRoot.innerHTML = "";
                return; 
            }
            
            divZbozi.innerHTML = "";
            let poJmenech = {}; let poZbozi = {};

            for (let id in data) {
                let o = data[id]; o.id = id;
                if (!poJmenech[o.zakaznik]) poJmenech[o.zakaznik] = { cena: 0, zaplaceno: 0 };
                poJmenech[o.zakaznik].cena += (o.skutecna_cena || 0);
                poJmenech[o.zakaznik].zaplaceno += (o.zaplaceno || 0);
                if (!poZbozi[o.produkty]) poZbozi[o.produkty] = [];
                poZbozi[o.produkty].push(o);
            }

            let sumarHtml = `<div class="sumar-box"><h3>游눯 SUM츼콎 K PLATB캨</h3><table><tr><th>Z치kazn칤k</th><th>Celkem Cena</th><th>Zaplaceno</th><th>Zb칳v치</th></tr>`;
            for (let jm in poJmenech) {
                let zb = poJmenech[jm].cena - poJmenech[jm].zaplaceno;
                sumarHtml += `<tr><td><b>${jm}</b></td><td>${poJmenech[jm].cena} K캜</td><td>${poJmenech[jm].zaplaceno} K캜</td><td class="${zb>0?'dluh':''}"><b>${zb} K캜</b></td></tr>`;
            }
            divSumarRoot.innerHTML = sumarHtml + `</table></div>`;

            for (let prod in poZbozi) {
                let cenaKg = cenyZbozi[prod] || 0;
                let html = `<div class="zbozi-sekce"><div class="zbozi-hlavicka"><span>游닍 ${prod}</span><span>${cenaKg} K캜/kg</span></div><table>`;
                poZbozi[prod].forEach(obj => {
                    html += `<tr><td><b>${obj.zakaznik}</b></td><td>${obj.vaha} kg</td>
                        <td><input type="number" class="input-vaha" value="${obj.skutecna_vaha_gr||''}" oninput="zivaCena('${obj.id}', this.value, ${cenaKg})" id="gr-${obj.id}"> gr</td>
                        <td id="disp-${obj.id}"><b>${obj.skutecna_cena || 0} K캜</b></td>
                        <td><input type="number" style="width:70px;" value="${obj.zaplaceno||0}" id="pay-${obj.id}"> K캜</td>
                        <td><button class="btn-save" onclick="uloz('${obj.id}', ${cenaKg}, '${prod}')">ULO콯IT</button></td></tr>`;
                });
                divZbozi.innerHTML += html + `</table></div>`;
            }
        });
    }

    function nactiStatistiky() {
        db.ref("statistiky").on("value", (snap) => {
            const stats = snap.val() || {};
            const divVahy = document.getElementById("vypis-statistiky");
            
            // Zobrazen칤 Ekonomiky
            const trzby = stats.trzby_celkem || 0;
            const naklady = stats.naklady_celkem || 0;
            const zisk = trzby - naklady;

            document.getElementById("stat-trzby").innerText = trzby + " K캜";
            document.getElementById("stat-naklady").innerText = naklady + " K캜";
            const ziskSpan = document.getElementById("stat-zisk");
            ziskSpan.innerText = zisk + " K캜";
            ziskSpan.className = zisk >= 0 ? "zisk-kladny" : "zisk-zaporny";

            // Zobrazen칤 Vah
            if (!stats.vahy) { divVahy.innerHTML = "Zat칤m 쮂멳n칠 nav치쬰n칠 zbo쮂."; return; }
            let html = "<table><tr><th>Druh zbo쮂</th><th>Celkem nav치쬰no</th></tr>";
            for (let k in stats.vahy) {
                html += `<tr><td>${k}</td><td><b>${(stats.vahy[k]/1000).toFixed(2)} kg</b></td></tr>`;
            }
            divVahy.innerHTML = html + "</table>";
        });
    }

    function pridejNaklad() {
        const castka = parseInt(document.getElementById("novy-naklad").value) || 0;
        if (castka > 0) {
            db.ref("statistiky/naklady_celkem").transaction((current) => (current || 0) + castka);
            document.getElementById("novy-naklad").value = "";
            alert("V칳daj byl zapo캜칤t치n.");
        }
    }

    function uloz(id, cenaKg, nazevZbozi) {
        const gr = parseInt(document.getElementById(`gr-${id}`).value) || 0;
        const pay = parseInt(document.getElementById(`pay-${id}`).value) || 0;
        const cena = Math.round((gr / 1000) * cenaKg);

        db.ref("objednavky/" + id).once("value").then((snap) => {
            const data = snap.val();
            const staraVaha = data.skutecna_vaha_gr || 0;
            const staraPlatba = data.zaplaceno || 0;
            
            const rozdilVaha = gr - staraVaha;
            const rozdilPlatba = pay - staraPlatba;

            // 1. Aktualizace objedn치vky
            db.ref("objednavky/" + id).update({ skutecna_vaha_gr: gr, skutecna_cena: cena, zaplaceno: pay });
            
            // 2. Aktualizace statistiky v치hy
            if (rozdilVaha !== 0) {
                db.ref("statistiky/vahy/" + nazevZbozi).transaction((current) => (current || 0) + rozdilVaha);
            }

            // 3. Aktualizace tr쬰b (po캜칤t치me z toho, co re치ln캩 "dostal" v poli Zaplaceno)
            if (rozdilPlatba !== 0) {
                db.ref("statistiky/trzby_celkem").transaction((current) => (current || 0) + rozdilPlatba);
            }
        });
    }

    function zivaCena(id, gramy, cenaKg) {
        document.getElementById("disp-" + id).innerText = Math.round((gramy / 1000) * cenaKg) + " K캜";
    }

    function resetStats() {
        if (confirm("POZOR! Sma쬰 to v코echny statistiky prodej콢, tr쬰b i n치klad콢. Chcete pokra캜ovat?")) {
            db.ref("statistiky").remove();
        }
    }
</script>
</body>
</html>
