<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rozpis - Vážení</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 10px; }
        .hlavicka { background: #1976d2; color: white; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .karta { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 6px solid #1976d2; }
        .vstup { width: 70px; padding: 8px; border: 2px solid #1976d2; border-radius: 5px; text-align: center; font-weight: bold; }
        .cena { font-weight: 900; color: #d32f2f; font-size: 1.2em; min-width: 80px; text-align: right; }
        .btn-ok { background: #2e7d32; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <div class="hlavicka">
        <h2 id="nadpis">Rozpis</h2>
        <a href="admin.html" style="color:white; text-decoration:none;">ZPĚT</a>
    </div>
    <div id="seznam"></div>

<script>
    const firebaseConfig = { databaseURL: "https://eshop-fh-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const urlParams = new URLSearchParams(window.location.search);
    const produktFiltr = urlParams.get('filtr');
    document.getElementById("nadpis").innerText = produktFiltr || "Rozpis";

    let cenaKg = 0;
    // 1. Zjistíme cenu pro tento list
    db.ref("produkty/" + produktFiltr).once("value", (s) => {
        cenaKg = s.val() || 0;
        // 2. Načteme lidi jen z tohoto listu
        db.ref("objednavky/" + produktFiltr).on("value", (snap) => {
            if (document.activeElement.tagName === "INPUT") return;
            const data = snap.val() || {};
            const seznam = document.getElementById("seznam");
            seznam.innerHTML = "";
            for (let id in data) {
                const obj = data[id];
                const g = obj.skutecna_vaha_gr || 0;
                const z = obj.zaplaceno || 0;
                const kc = Math.round((g / 1000) * cenaKg);
                seznam.innerHTML += `
                    <div class="karta">
                        <div><b>${obj.zakaznik}</b><br><small>Chce: ${obj.vaha} kg</small></div>
                        <input type="number" class="vstup" id="v-${id}" value="${g || ''}" placeholder="g" oninput="calc('${id}')" onchange="upd('${id}','skutecna_vaha_gr',this.value)">
                        <div class="cena" id="c-${id}">${kc} Kč</div>
                        <input type="number" class="vstup" id="z-${id}" value="${z || ''}" placeholder="Kč" onchange="upd('${id}','zaplaceno',this.value)">
                        <button class="btn-ok" onclick="hotovo('${id}','${obj.zakaznik}')">OK</button>
                    </div>`;
            }
        });
    });

    function calc(id) {
        const g = document.getElementById("v-" + id).value || 0;
        document.getElementById("c-" + id).innerText = Math.round((g / 1000) * cenaKg) + " Kč";
    }
    function upd(id, p, v) {
        db.ref("objednavky/" + produktFiltr + "/" + id).update({ [p]: parseInt(v) || 0 });
    }
    function hotovo(id, jm) {
        const kc = parseInt(document.getElementById("c-" + id).innerText);
        const zap = parseInt(document.getElementById("z-" + id).value) || 0;
        if (kc - zap > 0) {
            if (confirm("Zapsat dluh " + (kc-zap) + " Kč?")) {
                db.ref("dluhy").push({ jmeno: jm, zbozi: produktFiltr, castka: kc-zap });
            }
        }
        db.ref("objednavky/" + produktFiltr + "/" + id).remove();
    }
</script>
</body>
</html>
